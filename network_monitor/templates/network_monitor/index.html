<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# Make sure this meta tag exists and is correctly populated by Django's template engine #}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Network Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .host_output-box {
            background-color: #1a202c; /* Dark background for terminal-like output */
            color: #48bb78; /* Green text for successful output */
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            max-height: 50px;
            border-radius: 0.5rem; /* Rounded corners */
        }
        .ping-output-box {
            background-color: #1a202c; /* Dark background for terminal-like output */
            color: #48bb78; /* Green text for successful output */
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0.5rem; /* Rounded corners */
        }
        .ping_num {
            max-height:50px;
            max-width: 40px;
            text-align: center;
            border-radius: 0.5rem;
        }
        .status-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .status-light.active {
            background-color: #48bb78; /* Green */
            box-shadow: 0 0 8px #48bb78;
        }
        .status-light.inactive {
            background-color: #ef4444; /* Red */
            box-shadow: 0 0 8px #ef4444;
        }
        /* Custom button styles with Tailwind classes */
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105;
        }
        .btn-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg;
        }
        /* CSS for fading messages */
        #message-area {
            opacity: 0;
            transition: opacity 0.5s ease-out; /* Smooth transition over 0.5 seconds */
            display: none; /* Hidden by default, takes no space */
        }

        #message-area.show {
            opacity: 1;
            display: block; /* Make it visible */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Network Monitor Dashboard</h1>

        <div class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Ping a Host (One-Off)</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="pingHostInput" placeholder="Enter IP or Hostname (e.g., google.com)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <input type="text" id="num_pings" value="5" placeholder="5" class="ping_num p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button type="button" id="pingButton" class="btn-primary">Ping Host</button> {# Changed to type="button" #}
            </div>
            <div id="pingOutput" class="ping-output-box p-4 text-sm">
                Awaiting ping request...
            </div>
        </div>

        <div class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add Host to Monitor</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="hostname" placeholder="Enter Host Name"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <input type="text" id="host_ip" placeholder="Enter IP or Host name to monitor"
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button type="button" id="addMonitorButton" class="btn-primary">Add to Monitoring</button> {# Changed to type="button" #}
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4" >
                <input type="text" id="description" placeholder="Optional Host Description"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            </div>
            {# Adjusted message-area div. The displayMessage function targets this ID directly. #}
            <div id="message-area" class="text-sm mt-2"></div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monitored Hosts</h2>
            <div id="host-list-container" class="overflow-x-auto"> {# Added overflow-x-auto for responsiveness #}
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Status</th>
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">IP Address</th>
                            <th class="py-3 px-6 text-left">Last Down</th>
                            <th class="py-3 px-6 text-left">Last Checked</th>
                            <th class="py-3 px-6 text-center">Interval</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="host-table-body" class="text-gray-700 text-sm font-light">
                        {# Host data will be inserted here by JavaScript #}
                        <tr><td colspan="7" class="py-4 text-center text-gray-500">Loading monitored hosts...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Get CSRF Token from meta tag
        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // --- Message Display Function ---
        function displayMessage(elementId, message, isError = false, duration = 3000) {
            const element = document.getElementById(elementId);
            // Clear any existing timeouts to prevent conflicts if a new message comes in
            if (element._messageTimeout) {
                clearTimeout(element._messageTimeout);
                element._messageTimeout = null;
            }

            // Set the message and styling
            element.textContent = message; // Use textContent for security
            element.className = `text-sm mt-2 ${isError ? 'text-red-600' : 'text-green-600'} show`; // Add 'show' class for fade-in
            element.style.display = 'block'; // Ensure it's visible

            // Set a timeout to start clearing/fading the message
            element._messageTimeout = setTimeout(() => {
                element.classList.remove('show'); // Start fade out

                // After fadeDuration (0.5s from CSS), clear content and hide completely
                setTimeout(() => {
                    element.textContent = '';
                    element.className = `text-sm mt-2`; // Reset to base classes if any
                    element.style.display = 'none';
                }, 500); // This should match your CSS transition duration for opacity
            }, duration);
        }

        // --- Enter Key Press Handler ---
        function handleEnterKeyPress(event, buttonToClick) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission/line break
                buttonToClick.click();  // Programmatically click the associated button
            }
        }

        // --- Function to fetch and render monitored hosts ---
        async function fetchAndRenderHosts() {
            const tableBody = document.getElementById('host-table-body');
            // Show loading message only if table is currently empty
            if (tableBody.children.length === 0 || tableBody.children[0].colSpan === 7) { // Check if it's the loading row
                tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">Loading monitored hosts...</td></tr>';
            }

            try {
                const response = await fetch('/monitor/api/hosts/'); // Your Django API URL
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // Assuming your API returns { "hosts": [...] }

                tableBody.innerHTML = ''; // Clear existing rows

                if (data.hosts && data.hosts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">No hosts currently being monitored. Add one above!</td></tr>';
                    return;
                }

                data.hosts.forEach(host => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';

                    const statusClass = host.is_active ? 'active' : 'inactive';
                    const lastDowntimeText = host.last_downtime ? new Date(host.last_downtime).toLocaleString() : 'Never';
                    const lastDowntimeColor = host.last_downtime ? 'text-red-500 font-medium' : 'text-green-500';

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">
                            <span class="status-light ${statusClass}"></span>
                            <span class="font-medium">${host.is_active ? 'Online' : 'Offline'}</span>
                        </td>
                        <td class="py-3 px-6 text-left"><strong>${host.is_hostname}</strong></td>
                        <td class="py-3 px-6 text-left">${host.resolved_ip || host.ip_address || 'N/A'}</td>
                        <td class="py-3 px-6 text-left ${lastDowntimeColor}">${lastDowntimeText}</td>
                        <td class="py-3 px-6 text-left">${host.last_checked ? new Date(host.last_checked).toLocaleString() : 'N/A'}</td>
                        <td class="py-3 px-6 text-center">
                            <select id="freq-${host.id}" data-host-id="${host.id}" class="p-1 border border-gray-300 rounded-md text-sm">
                                <option value="1" ${host.ping_interval === 1 ? 'selected' : ''}>1 min</option>
                                <option value="5" ${host.ping_interval === 5 ? 'selected' : ''}>5 mins</option>
                                <option value="10" ${host.ping_interval === 10 ? 'selected' : ''}>10 mins</option>
                                <option value="30" ${host.ping_interval === 30 ? 'selected' : ''}>30 mins</option>
                                <option value="60" ${host.ping_interval === 60 ? 'selected' : ''}>1 hour</option>
                            </select>
                        </td>
                        <td class="py-3 px-6 text-center">
                            <button data-host-id="${host.id}" class="btn-danger delete-btn">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Re-attach event listeners for dynamically added elements
                document.querySelectorAll('select[id^="freq-"]').forEach(selectElement => {
                    selectElement.onchange = (event) => updatePingFrequency(event.target.dataset.hostId, event.target.value);
                });
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = (event) => deleteMonitorTarget(event.target.dataset.hostId);
                });

            } catch (error) {
                console.error('Error fetching monitored hosts:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-red-500">Failed to load hosts. Please check console for details.</td></tr>';
            }
        }

        // --- AJAX Functions (update/delete/add) ---

        // Function to update ping frequency (sends POST request to Django backend)
        async function updatePingFrequency(hostId, frequency) {
            try {
                const response = await fetch('/monitor/api/update_frequency/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // Include CSRF token
                    },
                    body: JSON.stringify({ id: hostId, frequency: frequency })
                });
                const data = await response.json();
                if (data.success) {
                    displayMessage('message-area', data.message, false);
                    // No need to re-fetch all hosts immediately, the change is usually reflected async on backend
                } else {
                    displayMessage('message-area', `Failed to update frequency: ${data.error}`, true, 10000);
                }
            } catch (error) {
                console.error('Error updating ping frequency:', error);
                displayMessage('message-area', 'An error occurred while updating frequency.', true, 10000);
            }
        }

        // Function to delete a monitored target (sends POST request to Django backend)
        async function deleteMonitorTarget(hostId) {
            if (!confirm('Are you sure you want to delete this monitored host?')) {
                return;
            }
            try {
                const response = await fetch('/monitor/api/delete_target/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // Include CSRF token
                    },
                    body: JSON.stringify({ id: hostId })
                });
                const data = await response.json();
                if (data.success) {
                    displayMessage('message-area', data.message, false);
                    fetchAndRenderHosts(); // Re-fetch to update the list immediately
                } else {
                    displayMessage('message-area', `Failed to delete target: ${data.message}`, true, 5000);
                }
            } catch (error) {
                console.error('Error deleting target:', error);
                displayMessage('message-area', 'An error occurred while deleting target.', true, 5000);
            }
        }

        // --- Main DOMContentLoaded Listener ---
        document.addEventListener('DOMContentLoaded', function() {
            // Get ping only textbox elements.
            const pingHostInput = document.getElementById('pingHostInput');
            const num_pings = document.getElementById('num_pings');
            const pingButton = document.getElementById('pingButton');

            // Get Add Monitor textbox elements.
            const hostname = document.getElementById('hostname');
            const host_ip = document.getElementById('host_ip');
            const description = document.getElementById('description');
            const addMonitorButton = document.getElementById('addMonitorButton');

            // Attach Enter key event listeners
            if (pingHostInput && num_pings && pingButton) {
                pingHostInput.addEventListener('keydown', (event) => handleEnterKeyPress(event, pingButton));
                num_pings.addEventListener('keydown', (event) => handleEnterKeyPress(event, pingButton));
            }

            if (hostname && host_ip && description && addMonitorButton) {
                hostname.addEventListener('keydown', (event) => handleEnterKeyPress(event, addMonitorButton));
                host_ip.addEventListener('keydown', (event) => handleEnterKeyPress(event, addMonitorButton));
                description.addEventListener('keydown', (event) => handleEnterKeyPress(event, addMonitorButton));
            }

            // Event Listener for Ping Button (one-off ping)
            pingButton.addEventListener('click', async () => {
                const host = pingHostInput.value.trim();
                const pingOutputDiv = document.getElementById('pingOutput');
                const numPings = parseInt(num_pings.value.trim() || '5');

                if (isNaN(numPings) || numPings < 1) {
                    pingOutputDiv.textContent = "Please insert a valid number of pings (e.g., 1 or more).";
                    pingOutputDiv.className = 'ping-output-box p-4 text-sm text-red-500';
                    return;
                }

                if (!host) {
                    pingOutputDiv.textContent = 'Please enter a host to ping.';
                    pingOutputDiv.className = 'ping-output-box p-4 text-sm text-red-500';
                    return;
                }

                pingOutputDiv.textContent = `Pinging ${host}... Please wait.`;
                pingOutputDiv.className = 'ping-output-box p-4 text-sm text-yellow-400';

                try {
                    const response = await fetch('/monitor/api/ping/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken() // Include CSRF token
                        },
                        body: JSON.stringify({ host: host, num_pings: numPings })
                    });
                    const data = await response.json();

                    if (data.success) {
                        pingOutputDiv.textContent = data.output || 'No output received.';
                        pingOutputDiv.className = `ping-output-box p-4 text-sm ${data.ping_successful ? 'text-green-400' : 'text-red-400'}`;
                        pingHostInput.value = "";
                        num_pings.value = "";
                        if (data.error) {
                            pingOutputDiv.textContent += `\nError: ${data.error}`;
                        }
                    } else {
                        pingOutputDiv.textContent = `Error: ${data.error}`;
                        pingOutputDiv.className = 'ping-output-box p-4 text-sm text-red-500';
                    }
                } catch (error) {
                    console.error('Error during ping request:', error);
                    pingOutputDiv.textContent = `An error occurred: ${error.message}`;
                    pingOutputDiv.className = 'ping-output-box p-4 text-sm text-red-500';
                }
            });

            // Event Listener for Add Monitor Button
            addMonitorButton.addEventListener('click', async () => {
                const hostVal = hostname.value.trim();
                const hostIpVal = host_ip.value.trim();
                const hostDescriptionVal = description.value.trim();

                if (!hostVal || !hostIpVal) {
                    displayMessage('message-area', "Please provide both a Host Name and an IP/Hostname to monitor.", true, 5000);
                    return;
                }

                displayMessage('message-area', 'Adding host to monitoring...', false);

                try {
                    const response = await fetch('/monitor/api/add_target/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken() // Include CSRF token
                        },
                        body: JSON.stringify({ host: hostVal, host_ip: hostIpVal, description: hostDescriptionVal })
                    });
                    const data = await response.json();

                    if (response.ok && data.success) { // Check response.ok for 2xx status codes
                        displayMessage('message-area', data.message, false);
                        hostname.value = ""; // Clear inputs
                        host_ip.value = "";
                        description.value = "";
                        fetchAndRenderHosts(); // Refresh the list of monitored hosts
                    } else {
                        // Handle server-side validation errors or other non-200 responses
                        const errorMessage = data.message || `Failed with status: ${response.status}`;
                        displayMessage('message-area', `Error: ${errorMessage}`, true, 10000);
                    }
                } catch (error) {
                    console.error('Error adding monitor target:', error);
                    displayMessage('message-area', `An error occurred: ${error.message}`, true, 10000);
                }
            });

            // Initial load of monitored hosts when the page loads
            fetchAndRenderHosts();

            // Periodically refresh the monitored hosts list
            setInterval(fetchAndRenderHosts, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>
